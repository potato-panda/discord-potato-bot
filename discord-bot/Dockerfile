FROM gradle:8.0.2-jdk17-alpine as BASE

WORKDIR /app

COPY gradle gradle
COPY src src
COPY build.gradle settings.gradle gradlew gradlew.bat settings.gradle gradle.properties src ./

RUN gradle shadowJar

FROM gradle:8.0.2-jdk17-alpine

WORKDIR /app

ENV NATS_NAME=$NATS_NAME
ENV MONGO_NAME=$MONGO_NAME
ENV REDIS_NAME=$REDIS_NAME

ENV DISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN
ENV ENV=$ENV
ENV DISCORD_DEV_GUILD_ID=$DISCORD_DEV_GUILD_ID
ENV ACS_CONTENT_MODERATOR_API_KEY=$ACS_CONTENT_MODERATOR_API_KEY

ENV ARTIFACT_NAME=discord-bot-1.0-SNAPSHOT-all.jar

COPY --from=BASE /app/build/libs/${ARTIFACT_NAME} /app/

CMD java \
    -DENV=$ENV \
    -DDISCORD_BOT_TOKEN=$DISCORD_BOT_TOKEN \
    -DDISCORD_DEV_GUILD_ID=$DISCORD_DEV_GUILD_ID \
    -DACS_CONTENT_MODERATOR_API_KEY=$ACS_CONTENT_MODERATOR_API_KEY \
    -DAWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
    -DAWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
    -jar $ARTIFACT_NAME
